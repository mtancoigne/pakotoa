#!/bin/sh

set -e

create_ca_tree()
{
  ca_name="$1"

  install -d -m 755 "${ca_name}"
  install -d -m 755 "${ca_name}/certs"
  install -d -m 755 "${ca_name}/crl"
  install -d -m 755 "${ca_name}/newcerts"
  install -d -m 700 "${ca_name}/private"

  touch "${ca_name}/index.txt"
  echo "01" > "${ca_name}/crlnumber"
  #echo "01" > "${ca_name}/serial"
}

if [ ! -d "config/ssl/0.root" ]; then
  create_ca_tree "config/ssl/0.root"
  openssl genrsa -out "config/ssl/0.root/private/cakey.pem" 2048
  openssl req -new -key "config/ssl/0.root/private/cakey.pem" -out "config/ssl/0.root/careq.pem" -config "config/ssl/openssl.cnf"
  openssl ca -create_serial -out "config/ssl/0.root/cacert.pem" -days 3650 -batch -keyfile "config/ssl/0.root/private/cakey.pem" -selfsign -extensions v3_ca -config "config/ssl/openssl.cnf" -name CA_root -infiles "config/ssl/0.root/careq.pem"
fi

for ca; do
  create_ca_tree "config/ssl/${ca}"
  openssl genrsa -out "config/ssl/${ca}/private/cakey.pem" 2048
  openssl req -new -key "config/ssl/${ca}/private/cakey.pem" -out "config/ssl/${ca}/careq.pem" -config "config/ssl/openssl.cnf"
  openssl ca -out "config/ssl/${ca}/cacert.pem" -days $((365*3)) -batch -keyfile "config/ssl/0.root/private/cakey.pem" -extensions v3_ca -config "config/ssl/openssl.cnf" -name CA_root -infiles "config/ssl/${ca}/careq.pem"
done
